#!/bin/bash
# macOS PKG postinstall script
# Runs as root AFTER files are installed to /Applications/Kaitu.app

K2="/Applications/Kaitu.app/Contents/MacOS/k2"
NE_APPEX="/Applications/Kaitu.app/Contents/PlugIns/KaituTunnel.appex"

# 1. Install daemon service (NE mode: skip — NE profile installed by app at runtime)
if [ -d "$NE_APPEX" ]; then
    # NE mode: KaituTunnel.appex is present — Network Extension handles VPN,
    # no daemon service needed. The NE profile is installed by the app at runtime
    # via ensure_ne_installed() in Rust.
    echo "NE mode: skipping daemon service install (KaituTunnel.appex present)"
else
    # Legacy daemon mode: install k2 service
    if [ -x "$K2" ]; then
        "$K2" service install 2>&1 || true
    fi
fi

# 2. Launch the newly installed Kaitu app as the logged-in user
CONSOLE_USER=$(stat -f "%Su" /dev/console)
if [ -n "$CONSOLE_USER" ] && [ "$CONSOLE_USER" != "root" ]; then
    sudo -u "$CONSOLE_USER" open /Applications/Kaitu.app &
fi

exit 0
