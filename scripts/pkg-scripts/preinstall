#!/bin/bash
# macOS PKG preinstall script
# Runs as root BEFORE files are copied to /Applications/Kaitu.app

K2="/Applications/Kaitu.app/Contents/MacOS/k2"

# 1. Quit the running Kaitu app and wait for it to exit (covers Kaitu + old kaitu-desktop)
if pgrep -f "Kaitu.app" >/dev/null 2>&1; then
    pkill -f "Kaitu.app" 2>/dev/null || true
    for i in $(seq 1 10); do
        pgrep -f "Kaitu.app" >/dev/null 2>&1 || break
        sleep 0.5
    done
    pkill -9 -f "Kaitu.app" 2>/dev/null || true
fi

# 2. Uninstall existing service (stop + remove plist)
if [ -x "$K2" ]; then
    "$K2" service uninstall 2>&1 || true
fi

# 3. Clean up all known launchd service variants (legacy + current formats)
for PLIST in \
    /Library/LaunchDaemons/io.kaitu.k2.plist \
    /Library/LaunchDaemons/io.kaitu.service.plist \
    /Library/LaunchDaemons/com.kaitu.service.plist \
    /Library/LaunchDaemons/kaitu.plist; do
    if [ -f "$PLIST" ]; then
        launchctl unload "$PLIST" 2>/dev/null || true
        rm -f "$PLIST"
    fi
done

# 4. Wait for cleanup
sleep 2

exit 0
