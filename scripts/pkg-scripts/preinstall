#!/bin/bash
# macOS PKG preinstall script
# Runs as root BEFORE files are copied to /Applications/Kaitu.app

K2="/Applications/Kaitu.app/Contents/MacOS/k2"

# 1. Quit the running Kaitu app and wait for it to exit
if pgrep -f "Kaitu.app/Contents/MacOS/Kaitu" >/dev/null 2>&1; then
    pkill -f "Kaitu.app/Contents/MacOS/Kaitu" 2>/dev/null || true
    # Wait up to 5s for graceful exit
    for i in $(seq 1 10); do
        pgrep -f "Kaitu.app/Contents/MacOS/Kaitu" >/dev/null 2>&1 || break
        sleep 0.5
    done
    # Force kill if still running
    pkill -9 -f "Kaitu.app/Contents/MacOS/Kaitu" 2>/dev/null || true
fi

# 2. Uninstall existing service (stop + remove plist)
if [ -x "$K2" ]; then
    "$K2" service uninstall 2>&1 || true
fi

# 3. Fallback: force unload if plist still exists (old kaitu-service format)
if [ -f /Library/LaunchDaemons/kaitu.plist ]; then
    launchctl unload /Library/LaunchDaemons/kaitu.plist 2>/dev/null || true
    rm -f /Library/LaunchDaemons/kaitu.plist
fi

# 4. Wait for cleanup
sleep 2

exit 0
