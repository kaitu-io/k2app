name: Release Desktop

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: universal-apple-darwin
            platform: macOS
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: Windows

    runs-on: ${{ matrix.os }}
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout k2 submodule
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.K2_DEPLOY_KEY }}

      - name: Init k2 submodule
        run: |
          git config --global url."git@github.com:".insteadOf "https://github.com/"
          git submodule update --init --recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: k2/go.sum

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.os == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || 'x86_64-pc-windows-msvc' }}

      - name: Cache Rust target directory
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            desktop/src-tauri/target
          key: rust-release-${{ runner.os }}-${{ hashFiles('desktop/src-tauri/Cargo.lock') }}
          restore-keys: |
            rust-release-${{ runner.os }}-

      - name: Install Node dependencies
        run: yarn install --frozen-lockfile

      - name: Run pre-build (Windows)
        if: matrix.os == 'windows-latest'
        run: make pre-build

      - name: Build webapp (Windows)
        if: matrix.os == 'windows-latest'
        run: make build-webapp

      # --- macOS: code signing certificate import ---

      - name: Import Apple code signing certificate
        if: matrix.os == 'macos-latest'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          echo "$APPLE_CERTIFICATE" | base64 --decode > "$CERTIFICATE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERTIFICATE_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      # --- macOS: full build via shared script ---

      - name: Build macOS (k2 + tauri + pkg)
        if: matrix.os == 'macos-latest'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_INSTALLER_IDENTITY: ${{ secrets.APPLE_INSTALLER_IDENTITY }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: bash scripts/build-macos.sh

      # --- Windows: SimpliSign authentication ---

      - name: Authenticate SimpliSign
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          pip install pyotp pywinauto -q
          python C:\actions-runner\scripts\simplisign_auto_login.py `
            --totp-uri "$env:SIMPLISIGN_TOTP_URI" `
            --username "$env:SIMPLISIGN_USERNAME"
        env:
          SIMPLISIGN_TOTP_URI: ${{ secrets.SIMPLISIGN_TOTP_URI }}
          SIMPLISIGN_USERNAME: ${{ secrets.SIMPLISIGN_USERNAME }}
        continue-on-error: true

      # --- Windows: build k2 + Tauri ---

      - name: Build k2 for Windows
        if: matrix.os == 'windows-latest'
        run: make build-k2 TARGET=x86_64-pc-windows-msvc
        env:
          GOARCH: amd64
          GOOS: windows

      - name: Build Tauri for Windows
        if: matrix.os == 'windows-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: yarn tauri build --target x86_64-pc-windows-msvc
        working-directory: desktop

      # --- Windows: code signing with SimpliSign + signtool ---

      - name: Sign Windows installer with SimpliSign
        if: matrix.os == 'windows-latest'
        id: windows-sign
        shell: pwsh
        run: |
          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
          if (-not (Test-Path $signtool)) {
            Write-Warning "signtool.exe not found at expected path"
            echo "signed=false" >> $env:GITHUB_OUTPUT
            exit 0
          }

          $installer = Get-ChildItem -Path "desktop\src-tauri\target\x86_64-pc-windows-msvc\release\bundle\nsis\*.exe" | Select-Object -First 1
          if (-not $installer) {
            Write-Warning "No installer found to sign"
            echo "signed=false" >> $env:GITHUB_OUTPUT
            exit 0
          }

          Write-Host "Signing: $($installer.FullName)"
          & $signtool sign /fd SHA256 /tr http://time.certum.pl /td SHA256 /d "Kaitu Desktop" "$($installer.FullName)"

          if ($LASTEXITCODE -ne 0) {
            Write-Warning "Signing failed (exit code: $LASTEXITCODE)"
            echo "signed=false" >> $env:GITHUB_OUTPUT
            exit 0
          }

          & $signtool verify /pa "$($installer.FullName)"
          Write-Host "Installer signed successfully"
          echo "signed=true" >> $env:GITHUB_OUTPUT
        continue-on-error: true

      - name: Notify Slack on signing failure
        if: matrix.os == 'windows-latest' && steps.windows-sign.outputs.signed != 'true'
        shell: bash
        run: |
          ./scripts/ci/notify-slack.sh build-failure \
            --platform "Windows" \
            --error "Windows code signing failed. Possible causes:
          1. SimpliSign Desktop not running or session expired on the runner
          2. signtool.exe not found (Windows SDK missing)
          3. Certificate not available in SimpliSign

          To fix: RDP into the Windows runner, ensure SimpliSign Desktop is
          running and authenticated, then re-run the workflow.

          See: scripts/ci/windows/README.md for setup instructions."
        env:
          SLACK_WEBHOOK_ALERT: ${{ secrets.SLACK_WEBHOOK_ALERT }}
        continue-on-error: true

      # --- Upload artifacts to S3 ---

      - name: Upload macOS to S3
        if: matrix.os == 'macos-latest'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-east-1
        run: |
          VERSION=$(node -p "require('./package.json').version")
          S3_BASE="s3://d0.all7.cc/kaitu/desktop/${VERSION}"
          aws s3 cp release/${VERSION}/ "${S3_BASE}/" --recursive --acl public-read

      - name: Upload Windows to S3
        if: matrix.os == 'windows-latest'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-east-1
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          S3_BASE="s3://d0.all7.cc/kaitu/desktop/${VERSION}"
          NSIS_DIR="desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis"
          aws s3 cp "${NSIS_DIR}/" "${S3_BASE}/" --recursive --acl public-read \
            --exclude "*" \
            --include "*.exe" --include "*.nsis.zip" --include "*.nsis.zip.sig"

      # --- Cleanup ---

      - name: Clean up keychain
        if: matrix.os == 'macos-latest' && always()
        run: security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" || true

      # --- Notifications ---

      - name: Notify Slack on build success
        if: success()
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          ./scripts/ci/notify-slack.sh deploy-success \
            --version "${VERSION}" \
            --platforms "${{ matrix.platform }}"
        env:
          SLACK_WEBHOOK_RELEASE: ${{ secrets.SLACK_WEBHOOK_RELEASE }}

      - name: Notify Slack on build failure
        if: failure()
        shell: bash
        run: |
          ./scripts/ci/notify-slack.sh build-failure \
            --platform "${{ matrix.platform }}" \
            --error "Release build failed on ${{ matrix.platform }}. Check workflow run for details."
        env:
          SLACK_WEBHOOK_ALERT: ${{ secrets.SLACK_WEBHOOK_ALERT }}
