name: Release Desktop

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-latest
            target: universal-apple-darwin
            platform: macOS
          - runner: [self-hosted, Windows, X64]
            target: x86_64-pc-windows-msvc
            platform: Windows

    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90

    steps:
      - name: Clean git global config (self-hosted)
        if: matrix.platform == 'Windows'
        shell: powershell
        run: git config --global --unset-all url."git@github.com:".insteadOf 2>$null; exit 0

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout k2 submodule
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.K2_DEPLOY_KEY }}

      - name: Init k2 submodule
        shell: bash
        run: git -c url."git@github.com:".insteadOf="https://github.com/" submodule update --init --recursive

      - name: Add user tools to PATH (self-hosted)
        if: matrix.platform == 'Windows'
        shell: bash
        run: |
          echo "C:\\Users\\david\\AppData\\Roaming\\npm" >> "$GITHUB_PATH"
          echo "C:\\Users\\david\\.cargo\\bin" >> "$GITHUB_PATH"
          echo "C:\\Users\\david\\AppData\\Local\\Programs\\Python\\Python312-arm64" >> "$GITHUB_PATH"
          echo "C:\\Users\\david\\AppData\\Local\\Programs\\Python\\Python312-arm64\\Scripts" >> "$GITHUB_PATH"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: k2/go.sum

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macOS' && 'aarch64-apple-darwin,x86_64-apple-darwin' || 'x86_64-pc-windows-msvc' }}

      - name: Cache Rust target directory
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            desktop/src-tauri/target
          key: rust-release-${{ runner.os }}-${{ hashFiles('desktop/src-tauri/Cargo.lock') }}
          restore-keys: |
            rust-release-${{ runner.os }}-

      - name: Install Node dependencies
        run: yarn install --frozen-lockfile

      - name: Run pre-build (Windows)
        if: matrix.platform == 'Windows'
        run: make pre-build

      - name: Build webapp (Windows)
        if: matrix.platform == 'Windows'
        run: make build-webapp

      # --- macOS: code signing certificate import ---

      - name: Import Apple code signing certificate
        if: matrix.platform == 'macOS'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          echo "$APPLE_CERTIFICATE" | base64 --decode > "$CERTIFICATE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERTIFICATE_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      # --- macOS: full build via shared script ---

      - name: Build macOS (k2 + tauri + pkg)
        if: matrix.platform == 'macOS'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_INSTALLER_IDENTITY: ${{ secrets.APPLE_INSTALLER_IDENTITY }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: bash scripts/build-macos.sh

      # --- Windows: SimpliSign authentication ---

      - name: Authenticate SimpliSign
        if: matrix.platform == 'Windows'
        shell: powershell
        run: |
          pip install pyotp pywinauto -q
          python C:\actions-runner\scripts\simplisign_auto_login.py `
            --totp-uri "$env:SIMPLISIGN_TOTP_URI" `
            --username "$env:SIMPLISIGN_USERNAME"
        env:
          SIMPLISIGN_TOTP_URI: ${{ secrets.SIMPLISIGN_TOTP_URI }}
          SIMPLISIGN_USERNAME: ${{ secrets.SIMPLISIGN_USERNAME }}
        continue-on-error: true

      # --- Windows: build k2 + Tauri ---

      - name: Build k2 for Windows
        if: matrix.platform == 'Windows'
        run: make build-k2 TARGET=x86_64-pc-windows-msvc
        env:
          GOARCH: amd64
          GOOS: windows

      - name: Build Tauri for Windows
        if: matrix.platform == 'Windows'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: yarn tauri build --target x86_64-pc-windows-msvc
        working-directory: desktop

      # --- Windows: code signing with SimpliSign + signtool ---

      - name: Sign Windows installer
        if: matrix.platform == 'Windows'
        shell: powershell
        run: |
          # Dynamic signtool discovery
          $signtool = $null
          $sdkRoot = "C:\Program Files (x86)\Windows Kits\10\bin"
          if (Test-Path $sdkRoot) {
            $signtool = Get-ChildItem -Path $sdkRoot -Recurse -Filter "signtool.exe" -ErrorAction SilentlyContinue |
              Where-Object { $_.FullName -like "*\x64\*" } |
              Sort-Object { [version]($_.Directory.Parent.Name -replace '[^0-9.]','') } -Descending -ErrorAction SilentlyContinue |
              Select-Object -First 1 -ExpandProperty FullName
          }
          if (-not $signtool) {
            Write-Error "signtool.exe not found. Install Windows SDK on this runner."
            exit 1
          }
          Write-Host "Found signtool: $signtool"

          $installer = Get-ChildItem -Path "desktop\src-tauri\target\x86_64-pc-windows-msvc\release\bundle\nsis\*.exe" | Select-Object -First 1
          if (-not $installer) {
            Write-Error "No installer .exe found in NSIS bundle output"
            exit 1
          }

          Write-Host "Signing: $($installer.FullName)"
          & $signtool sign /fd SHA256 /tr http://time.certum.pl /td SHA256 /d "Kaitu Desktop" "$($installer.FullName)"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "signtool sign failed (exit code: $LASTEXITCODE)"
            exit 1
          }

          & $signtool verify /pa "$($installer.FullName)"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "signtool verify failed â€” signature is invalid"
            exit 1
          }
          Write-Host "Installer signed and verified successfully"

      # --- Upload artifacts to S3 ---

      - name: Upload macOS to S3
        if: matrix.platform == 'macOS'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-east-1
        run: |
          VERSION=$(node -p "require('./package.json').version")
          S3_BASE="s3://d0.all7.cc/kaitu/desktop/${VERSION}"
          aws s3 cp release/${VERSION}/ "${S3_BASE}/" --recursive
      - name: Upload Windows to S3
        if: matrix.platform == 'Windows'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-east-1
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          S3_BASE="s3://d0.all7.cc/kaitu/desktop/${VERSION}"
          NSIS_DIR="desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis"
          aws s3 cp "${NSIS_DIR}/" "${S3_BASE}/" --recursive \
            --exclude "*" \
            --include "*.exe" --include "*.exe.sig"

      # --- Cleanup ---

      - name: Clean up keychain
        if: matrix.platform == 'macOS' && always()
        run: security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" || true

      # --- Notifications ---

      - name: Notify Slack on build success
        if: success()
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          ./scripts/ci/notify-slack.sh deploy-success \
            --version "${VERSION}" \
            --platforms "${{ matrix.platform }}"
        env:
          SLACK_WEBHOOK_RELEASE: ${{ secrets.SLACK_WEBHOOK_RELEASE }}

      - name: Notify Slack on build failure
        if: failure()
        shell: bash
        run: |
          ./scripts/ci/notify-slack.sh build-failure \
            --platform "${{ matrix.platform }}" \
            --error "Release build failed on ${{ matrix.platform }}. Check workflow run for details."
        env:
          SLACK_WEBHOOK_ALERT: ${{ secrets.SLACK_WEBHOOK_ALERT }}
